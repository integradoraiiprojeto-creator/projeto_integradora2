<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento em Tempo Real</title>
  <style>
    /* ============ ESTILOS PRINCIPAIS ============ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #e5e7eb;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* Barra superior com informa√ß√µes do usu√°rio */
    .user-info-bar {
      background: rgba(15, 23, 42, 0.95);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(56, 189, 248, 0.2);
      position: sticky;
      top: 0;
      z-index: 1000;
      width: 100%;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .user-info i {
      color: #38bdf8;
      font-size: 18px;
    }

    #btnLogout {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.4);
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      font-weight: 600;
    }

    #btnLogout:hover {
      background: rgba(239, 68, 68, 0.3);
      transform: translateY(-2px);
    }
    
    .container {
      display: flex;
      gap: 30px;
      max-width: 1400px;
      margin: 30px auto;
      padding: 0 30px;
      min-height: calc(100vh - 100px);
    }
    
    .card {
      background: rgba(15, 23, 42, 0.9);
      padding: 25px;
      border-radius: 16px;
      width: 380px;
      min-width: 380px;
      flex-shrink: 0;
      border: 1px solid rgba(56, 189, 248, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }
    
    .historico-container {
      flex: 1;
      background: rgba(15, 23, 42, 0.9);
      padding: 25px;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(56, 189, 248, 0.15);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      min-height: 600px;
    }
    
    h1 {
      text-align: center;
      margin-bottom: 25px;
      color: #38bdf8;
      font-size: 1.6rem;
      position: relative;
      padding-bottom: 10px;
    }
    
    h1:after {
      content: '';
      display: block;
      width: 60px;
      height: 3px;
      background: #38bdf8;
      margin: 10px auto;
      border-radius: 2px;
    }
    
    .info-paciente {
      background: rgba(30, 41, 59, 0.7);
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 25px;
      border-left: 4px solid #38bdf8;
    }
    
    .info-paciente div {
      margin: 10px 0;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-paciente i {
      color: #38bdf8;
      width: 20px;
    }
    
    .sensor {
      margin: 15px 0;
      padding: 15px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      font-size: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .sensor:hover {
      background: rgba(30, 41, 59, 0.7);
      border-color: rgba(56, 189, 248, 0.2);
    }
    
    .sensor span:first-child {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
    }
    
    .sensor i {
      font-size: 20px;
    }
    
    .valor {
      font-weight: bold;
      font-size: 1.3rem;
      padding: 8px 16px;
      background: rgba(56, 189, 248, 0.1);
      border-radius: 8px;
      min-width: 100px;
      text-align: center;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }
    
    .tabela-wrapper {
      flex: 1;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid rgba(56, 189, 248, 0.1);
      background: rgba(2, 6, 23, 0.5);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      background: rgba(15, 23, 42, 0.95);
      padding: 15px;
      text-align: left;
      font-weight: 600;
      border-bottom: 2px solid #38bdf8;
      color: #38bdf8;
      font-size: 14px;
    }
    
    td {
      padding: 14px 15px;
      border-bottom: 1px solid rgba(51, 65, 85, 0.5);
      font-size: 14px;
    }
    
    tbody tr:hover {
      background: rgba(56, 189, 248, 0.1);
    }
    
    .data-hora {
      color: #94a3b8;
      font-size: 13px;
      font-family: 'Consolas', monospace;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .controles {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    select, button {
      padding: 10px 15px;
      background: rgba(30, 41, 59, 0.8);
      color: white;
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      outline: none;
    }
    
    select:hover, button:hover {
      border-color: #38bdf8;
      background: rgba(56, 189, 248, 0.15);
    }
    
    button {
      background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      border: none;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    button:hover {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
    }
    
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 25px;
      padding: 15px;
      background: rgba(30, 41, 59, 0.5);
      border-radius: 12px;
      font-size: 14px;
      border: 1px solid rgba(56, 189, 248, 0.1);
    }
    
    .status {
      padding: 6px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .online {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .online::before {
      background: #10b981;
    }
    
    .offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .offline::before {
      background: #ef4444;
    }
    
    /* Bot√µes para alternar entre tabela e gr√°fico */
    .toggle-visualizacao {
      display: flex;
      gap: 2px;
      background: rgba(30, 41, 59, 0.8);
      padding: 4px;
      border-radius: 8px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }
    
    .btn-visualizacao {
      padding: 8px 15px;
      background: transparent;
      color: #94a3b8;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .btn-visualizacao.active {
      background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
      color: white;
    }
    
    .btn-visualizacao:hover:not(.active) {
      background: rgba(56, 189, 248, 0.1);
      color: #e5e7eb;
    }
    
    /* Container do gr√°fico */
    .grafico-container {
      background: rgba(2, 6, 23, 0.7);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid rgba(56, 189, 248, 0.1);
      height: 400px;
      display: none;
      margin-bottom: 15px;
    }
    
    .visualizacao-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    #contadorRegistros {
      margin-top: 15px;
      text-align: center;
      color: #94a3b8;
      font-size: 13px;
      padding: 10px;
      background: rgba(30, 41, 59, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(56, 189, 248, 0.1);
    }
    
    /* ============ RESPONSIVIDADE ============ */
    @media (max-width: 1200px) {
      .container {
        flex-direction: column;
        padding: 20px;
      }
      
      .card {
        width: 100%;
        max-width: 100%;
        min-width: unset;
      }
      
      .historico-container {
        width: 100%;
        min-height: 500px;
      }
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      
      .card, .historico-container {
        padding: 20px;
      }
      
      .controles {
        flex-direction: column;
        align-items: stretch;
      }
      
      select, button {
        width: 100%;
        justify-content: center;
      }
      
      .toggle-visualizacao {
        width: 100%;
        justify-content: center;
      }
    }
    
    /* ============ ANIMA√á√ïES ============ */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .container {
      animation: fadeIn 0.5s ease-out;
    }
    
    /* ============ CORES DIN√ÇMICAS PARA VALORES ============ */
    .valor.normal { color: #10b981; border-color: rgba(16, 185, 129, 0.3); background: rgba(16, 185, 129, 0.1); }
    .valor.alerta { color: #f59e0b; border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1); }
    .valor.critico { color: #ef4444; border-color: rgba(239, 68, 68, 0.3); background: rgba(239, 68, 68, 0.1); }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Barra superior com informa√ß√µes do usu√°rio -->
  <div class="user-info-bar">
    <div class="user-info">
      <i class="fas fa-user-md"></i>
      <span id="loggedUserInfo">Carregando informa√ß√µes do usu√°rio...</span>
    </div>
    <button id="btnLogout">
      <i class="fas fa-sign-out-alt"></i> Sair do Sistema
    </button>
  </div>

  <div class="container">
    <!-- Card dos sensores em tempo real -->
    <div class="card">
      <h1><i class="fas fa-heart-pulse"></i> Monitoramento em Tempo Real</h1>
      
      <div class="info-paciente">
        <div><i class="fas fa-user"></i> <strong>Paciente:</strong> <span id="nomePaciente">--</span></div>
        <div><i class="fas fa-id-card"></i> <strong>ID:</strong> <span id="idPaciente">--</span></div>
        <div><i class="fas fa-venus-mars"></i> <strong>Sexo:</strong> <span id="sexoPaciente">--</span></div>
      </div>
      
      <div class="sensor">
        <span><i class="fas fa-heart" style="color: #ef4444;"></i> Frequ√™ncia Card√≠aca</span>
        <span class="valor" id="freq">-- bpm</span>
      </div>
      
      <div class="sensor">
        <span><i class="fas fa-tint" style="color: #38bdf8;"></i> Oximetria</span>
        <span class="valor" id="oxi">-- %</span>
      </div>
      
      <div class="sensor">
        <span><i class="fas fa-thermometer-half" style="color: #f59e0b;"></i> Temperatura</span>
        <span class="valor" id="temp">-- ¬∞C</span>
      </div>
      
      <div class="status-bar">
        <div>
          <strong>√öltima atualiza√ß√£o:</strong> 
          <span id="ultimaAtualizacao">--:--:--</span>
        </div>
        <span class="status online" id="status">
          <i class="fas fa-wifi"></i> CONECTADO
        </span>
      </div>
    </div>

    <!-- Se√ß√£o de hist√≥rico -->
    <div class="historico-container">
      <h1><i class="fas fa-history"></i> Hist√≥rico de Sensores</h1>
      
      <div class="controles">
        <!-- Bot√µes para alternar entre tabela e gr√°fico -->
        <div class="toggle-visualizacao">
          <button class="btn-visualizacao active" data-tipo="tabela">
            <i class="fas fa-table"></i> Tabela
          </button>
          <button class="btn-visualizacao" data-tipo="grafico">
            <i class="fas fa-chart-line"></i> Gr√°fico
          </button>
        </div>
        
        <select id="selectOrdenar">
          <option value="recente">Mais recente primeiro</option>
          <option value="antigo">Mais antigo primeiro</option>
        </select>
        
        <button id="btnAtualizar">
          <i class="fas fa-sync-alt"></i> Atualizar
        </button>
        
        <button id="btnExportarCSV">
          <i class="fas fa-file-export"></i> Exportar CSV
        </button>
      </div>
      
      <!-- Container para as visualiza√ß√µes -->
      <div class="visualizacao-container">
        <!-- Container do gr√°fico (oculto por padr√£o) -->
        <div class="grafico-container" id="graficoContainer">
          <canvas id="graficoLinhas"></canvas>
        </div>
        
        <!-- Container da tabela (vis√≠vel por padr√£o) -->
        <div class="tabela-wrapper" id="tabelaContainer">
          <table>
            <thead>
              <tr>
                <th>Data/Hora</th>
                <th>Frequ√™ncia Card√≠aca</th>
                <th>Oximetria</th>
                <th>Temperatura</th>
              </tr>
            </thead>
            <tbody id="tabelaCorpo">
              <tr>
                <td colspan="4" style="text-align: center; padding: 40px;">
                  <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div id="contadorRegistros">
          <i class="fas fa-database"></i> 0 registros encontrados
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    console.log("üöÄ Sistema iniciado...");
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDURF1Z7S-O0y1mfc0Sf8sjY9KGLJwkYHY",
      authDomain: "projeto-integradora-ii.firebaseapp.com",
      databaseURL: "https://projeto-integradora-ii-default-rtdb.firebaseio.com",
      projectId: "projeto-integradora-ii",
      storageBucket: "projeto-integradora-ii.firebasestorage.app",
      messagingSenderId: "80939508930",
      appId: "1:80939508930:web:9a2d2f9bf97be9eb98075b"
    };

    // =============================================
    // VERIFICA√á√ÉO DE AUTENTICA√á√ÉO
    // =============================================
    function verificarAutenticacao() {
      const usuarioLogado = sessionStorage.getItem('usuarioLogado');
      const loginTime = sessionStorage.getItem('loginTime');
      
      if (!usuarioLogado || !loginTime) {
        console.log('‚ö†Ô∏è Usu√°rio n√£o autenticado. Redirecionando...');
        window.location.href = 'index.html';
        return null;
      }
      
      const tempoLogin = new Date(loginTime);
      const tempoAtual = new Date();
      const diferencaMinutos = (tempoAtual - tempoLogin) / (1000 * 60);
      
      if (diferencaMinutos > 30) {
        console.log('‚è∞ Sess√£o expirada. Redirecionando...');
        sessionStorage.clear();
        alert('Sua sess√£o expirou. Por favor, fa√ßa login novamente.');
        window.location.href = 'index.html';
        return null;
      }
      
      sessionStorage.setItem('loginTime', new Date().toISOString());
      
      return JSON.parse(usuarioLogado);
    }

    // Verificar autentica√ß√£o
    const usuarioAutenticado = verificarAutenticacao();
    if (!usuarioAutenticado) {
      console.log('‚ùå Usu√°rio n√£o autenticado. Encerrando execu√ß√£o.');
      throw new Error('Usu√°rio n√£o autenticado');
    }

    console.log(`üë§ Usu√°rio autenticado: ${usuarioAutenticado.nome} (${usuarioAutenticado.perfil})`);
    
    // Atualizar barra de informa√ß√µes do usu√°rio
    document.getElementById('loggedUserInfo').textContent = 
      `${usuarioAutenticado.nome} | ${usuarioAutenticado.perfil}`;

    // Adicionar evento de logout
    document.getElementById('btnLogout').addEventListener('click', () => {
      if (confirm('Deseja realmente sair do sistema?')) {
        sessionStorage.clear();
        window.location.href = 'index.html';
      }
    });

    // =============================================
    // ALTERN√ÇNCIA ENTRE TABELA E GR√ÅFICO
    // =============================================
    const tabelaContainer = document.getElementById('tabelaContainer');
    const graficoContainer = document.getElementById('graficoContainer');
    const btnVisualizacoes = document.querySelectorAll('.btn-visualizacao');
    let graficoLinhas = null;
    let registrosAgrupados = [];

    // Event listeners para bot√µes de altern√¢ncia
    btnVisualizacoes.forEach(btn => {
      btn.addEventListener('click', function() {
        // Remover classe active de todos os bot√µes
        btnVisualizacoes.forEach(b => b.classList.remove('active'));
        
        // Adicionar classe active ao bot√£o clicado
        this.classList.add('active');
        
        const tipo = this.dataset.tipo;
        
        // Alternar entre tabela e gr√°fico
        if (tipo === 'tabela') {
          tabelaContainer.style.display = 'block';
          graficoContainer.style.display = 'none';
        } else if (tipo === 'grafico') {
          tabelaContainer.style.display = 'none';
          graficoContainer.style.display = 'block';
          
          // Se j√° tiver dados, renderizar gr√°fico
          if (registrosAgrupados && registrosAgrupados.length > 0) {
            renderizarGrafico(registrosAgrupados);
          } else {
            graficoContainer.innerHTML = `
              <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #94a3b8;">
                <i class="fas fa-chart-line fa-3x" style="margin-bottom: 20px;"></i>
                <p>Carregando dados para o gr√°fico...</p>
              </div>
            `;
          }
        }
      });
    });

    // Fun√ß√£o para renderizar gr√°fico
    function renderizarGrafico(dadosAgrupados) {
      // Limitar a 30 pontos para melhor performance
      const dadosLimitados = dadosAgrupados.slice(0, 30);
      
      // Inverter ordem para mostrar do mais antigo ao mais recente no gr√°fico
      const dadosOrdenados = [...dadosLimitados].reverse();
      
      // Preparar dados para o gr√°fico
      const labels = dadosOrdenados.map(d => {
        // Formatar data para exibi√ß√£o mais curta (apenas hora)
        const [data, hora] = d.dataFormatada.split(' ');
        return `${hora}`;
      });
      
      const dadosFreq = dadosOrdenados.map(d => {
        const valor = d.freq_cardiaca === '--' ? null : parseFloat(d.freq_cardiaca);
        return valor;
      });
      
      const dadosOxi = dadosOrdenados.map(d => {
        const valor = d.oximetria === '--' ? null : parseFloat(d.oximetria);
        return valor;
      });
      
      const dadosTemp = dadosOrdenados.map(d => {
        const valor = d.temperatura === '--' ? null : parseFloat(d.temperatura);
        return valor;
      });
      
      // Verificar se j√° existe um gr√°fico e destruir
      if (graficoLinhas) {
        graficoLinhas.destroy();
      }
      
      // Criar canvas se n√£o existir
      if (!document.getElementById('graficoLinhas')) {
        graficoContainer.innerHTML = '<canvas id="graficoLinhas"></canvas>';
      }
      
      const ctx = document.getElementById('graficoLinhas').getContext('2d');
      
      // Criar o gr√°fico
      graficoLinhas = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Frequ√™ncia Card√≠aca (bpm)',
              data: dadosFreq,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 3
            },
            {
              label: 'Oximetria (%)',
              data: dadosOxi,
              borderColor: '#38bdf8',
              backgroundColor: 'rgba(56, 189, 248, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 3
            },
            {
              label: 'Temperatura (¬∞C)',
              data: dadosTemp,
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.4,
              pointRadius: 3
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                color: '#e5e7eb',
                font: {
                  size: 12
                }
              }
            }
          },
          scales: {
            x: {
              grid: {
                color: 'rgba(56, 189, 248, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            },
            y: {
              grid: {
                color: 'rgba(56, 189, 248, 0.1)'
              },
              ticks: {
                color: '#94a3b8'
              }
            }
          }
        }
      });
    }

    // =============================================
    // SISTEMA DE MONITORAMENTO
    // =============================================
    try {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      
      // Elementos da p√°gina
      const elementos = {
        freq: document.getElementById('freq'),
        oxi: document.getElementById('oxi'),
        temp: document.getElementById('temp'),
        nomePaciente: document.getElementById('nomePaciente'),
        idPaciente: document.getElementById('idPaciente'),
        sexoPaciente: document.getElementById('sexoPaciente'),
        tabelaCorpo: document.getElementById('tabelaCorpo'),
        btnAtualizar: document.getElementById('btnAtualizar'),
        btnExportarCSV: document.getElementById('btnExportarCSV'),
        selectOrdenar: document.getElementById('selectOrdenar'),
        status: document.getElementById('status'),
        ultimaAtualizacao: document.getElementById('ultimaAtualizacao'),
        contadorRegistros: document.getElementById('contadorRegistros')
      };

      // Refer√™ncias do Firebase
      const refs = {
        paciente: ref(db, "Paciente"),
        sensoresAtuais: ref(db, "sensores_atuais"),
        historico: ref(db, "sensores_historico")
      };

      let dadosHistorico = null;
      let ultimaAtualizacao = new Date();

      // Atualizar timestamp
      function atualizarTimestamp() {
        elementos.ultimaAtualizacao.textContent = new Date().toLocaleTimeString('pt-BR');
      }

      // Carregar dados do paciente
      onValue(refs.paciente, (snapshot) => {
        const paciente = snapshot.val();
        if (paciente) {
          elementos.nomePaciente.textContent = paciente.nome || "N√£o informado";
          elementos.idPaciente.textContent = paciente.id_paciente || "N√£o informado";
          elementos.sexoPaciente.textContent = paciente.sexo === 'M' ? 'Masculino' : 
                                             paciente.sexo === 'F' ? 'Feminino' : 'N√£o informado';
        }
      });

      // Carregar sensores atuais
      onValue(refs.sensoresAtuais, (snapshot) => {
        const sensores = snapshot.val();
        if (sensores) {
          atualizarSensores(sensores);
          ultimaAtualizacao = new Date();
          atualizarTimestamp();
          elementos.status.className = "status online";
          elementos.status.innerHTML = '<i class="fas fa-wifi"></i> CONECTADO';
        }
      });

      // Carregar hist√≥rico
      onValue(refs.historico, (snapshot) => {
        dadosHistorico = snapshot.val();
        if (dadosHistorico) {
          console.log("üìö Hist√≥rico carregado:", dadosHistorico);
          atualizarTabelaHistorico();
        }
      });

      // Atualizar sensores em tempo real com cores din√¢micas
      function atualizarSensores(sensores) {
        // Frequ√™ncia card√≠aca
        if (sensores.freq_cardiaca !== undefined) {
          elementos.freq.textContent = `${sensores.freq_cardiaca} bpm`;
          
          // Determinar status
          let status = 'normal';
          if (sensores.freq_cardiaca > 100 || sensores.freq_cardiaca < 60) {
            status = 'critico';
          } else if (sensores.freq_cardiaca > 90 || sensores.freq_cardiaca < 65) {
            status = 'alerta';
          }
          
          // Aplicar classe de status
          elementos.freq.className = 'valor ' + status;
        }
        
        // Oximetria
        if (sensores.oximetria !== undefined) {
          elementos.oxi.textContent = `${sensores.oximetria} %`;
          
          // Determinar status
          let status = 'normal';
          if (sensores.oximetria < 95) {
            status = 'critico';
          } else if (sensores.oximetria < 97) {
            status = 'alerta';
          }
          
          // Aplicar classe de status
          elementos.oxi.className = 'valor ' + status;
        }
        
        // Temperatura
        if (sensores.temperatura !== undefined) {
          elementos.temp.textContent = `${sensores.temperatura} ¬∞C`;
          
          // Determinar status
          let status = 'normal';
          if (sensores.temperatura > 37.5) {
            status = 'critico';
          } else if (sensores.temperatura > 37.2) {
            status = 'alerta';
          }
          
          // Aplicar classe de status
          elementos.temp.className = 'valor ' + status;
        }
      }

      // Atualizar tabela de hist√≥rico - AGRUPADO POR DATA/HORA
      function atualizarTabelaHistorico() {
        if (!dadosHistorico) return;
        
        console.log("üîÑ Processando hist√≥rico...");
        
        const ordenacao = elementos.selectOrdenar.value;
        
        // Objeto para agrupar por data/hora
        const registrosPorData = {};
        
        // Processar TODOS os sensores e agrupar por data/hora
        processarEAgruparDados(dadosHistorico, registrosPorData);
        
        // Converter objeto para array
        registrosAgrupados = Object.values(registrosPorData);
        
        console.log(`üìä ${registrosAgrupados.length} registros agrupados por data/hora`);
        
        // Ordenar
        if (ordenacao === 'recente') {
          registrosAgrupados.sort((a, b) => b.dataCompleta.localeCompare(a.dataCompleta));
        } else {
          registrosAgrupados.sort((a, b) => a.dataCompleta.localeCompare(b.dataCompleta));
        }
        
        // Atualizar contador
        elementos.contadorRegistros.innerHTML = `<i class="fas fa-database"></i> ${registrosAgrupados.length} registros encontrados`;
        
        // Renderizar tabela
        renderizarTabelaAgrupada(registrosAgrupados);
        
        // Se estiver na visualiza√ß√£o de gr√°fico, atualizar gr√°fico tamb√©m
        const btnGraficoAtivo = document.querySelector('.btn-visualizacao[data-tipo="grafico"].active');
        if (btnGraficoAtivo && registrosAgrupados.length > 0) {
          renderizarGrafico(registrosAgrupados);
        }
      }

      // Processar e agrupar dados por data/hora
      function processarEAgruparDados(dados, objetoAgrupado) {
        // Processar frequ√™ncia card√≠aca
        if (dados.freq_cardiaca) {
          processarSensorParaAgrupamento('freq_cardiaca', dados.freq_cardiaca, objetoAgrupado);
        }
        
        // Processar oximetria
        if (dados.oximetria) {
          processarSensorParaAgrupamento('oximetria', dados.oximetria, objetoAgrupado);
        }
        
        // Processar temperatura
        if (dados.temperatura) {
          processarSensorParaAgrupamento('temperatura', dados.temperatura, objetoAgrupado);
        }
      }

      // Processar um sensor espec√≠fico para agrupamento
      function processarSensorParaAgrupamento(tipo, dadosSensor, objetoAgrupado) {
        // Para cada data/hora (ex: "1969-12-31_21-00-03")
        Object.entries(dadosSensor).forEach(([dataHoraString, registrosData]) => {
          // Para cada registro dentro da data/hora
          Object.entries(registrosData).forEach(([idRegistro, valor]) => {
            
            // Se ainda n√£o tem registro para esta data/hora, criar
            if (!objetoAgrupado[dataHoraString]) {
              const dataFormatada = formatarData(dataHoraString);
              const hora = extrairHora(dataHoraString);
              
              objetoAgrupado[dataHoraString] = {
                dataHoraString: dataHoraString,
                dataFormatada: `${dataFormatada} ${hora}`,
                dataCompleta: dataHoraString,
                freq_cardiaca: '--',
                oximetria: '--',
                temperatura: '--'
              };
            }
            
            // Adicionar o valor do sensor ao registro agrupado
            if (tipo === 'freq_cardiaca') {
              objetoAgrupado[dataHoraString].freq_cardiaca = valor;
            } else if (tipo === 'oximetria') {
              objetoAgrupado[dataHoraString].oximetria = valor;
            } else if (tipo === 'temperatura') {
              objetoAgrupado[dataHoraString].temperatura = valor;
            }
          });
        });
      }

      // Renderizar tabela com dados agrupados
      function renderizarTabelaAgrupada(registrosAgrupados) {
        elementos.tabelaCorpo.innerHTML = '';
        
        if (registrosAgrupados.length === 0) {
          elementos.tabelaCorpo.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 40px;">
                <i class="fas fa-inbox"></i> Nenhum registro encontrado
              </td>
            </tr>
          `;
          return;
        }
        
        registrosAgrupados.forEach(registro => {
          const tr = document.createElement('tr');
          
          // Determinar cores baseadas nos valores
          const freqClass = getStatusFreq(registro.freq_cardiaca);
          const oxiClass = getStatusOxi(registro.oximetria);
          const tempClass = getStatusTemp(registro.temperatura);
          
          tr.innerHTML = `
            <td class="data-hora">
              <i class="far fa-calendar"></i> ${registro.dataFormatada}
            </td>
            <td class="${freqClass}">${registro.freq_cardiaca !== '--' ? registro.freq_cardiaca + ' bpm' : '--'}</td>
            <td class="${oxiClass}">${registro.oximetria !== '--' ? registro.oximetria + ' %' : '--'}</td>
            <td class="${tempClass}">${registro.temperatura !== '--' ? registro.temperatura + ' ¬∞C' : '--'}</td>
          `;
          
          elementos.tabelaCorpo.appendChild(tr);
        });
      }

      // Fun√ß√µes auxiliares para determinar status
      function getStatusFreq(valor) {
        if (valor === '--') return '';
        const num = parseFloat(valor);
        if (num > 100 || num < 60) return 'valor-critico';
        if (num > 90 || num < 65) return 'valor-alerta';
        return 'valor-normal';
      }

      function getStatusOxi(valor) {
        if (valor === '--') return '';
        const num = parseFloat(valor);
        if (num < 95) return 'valor-critico';
        if (num < 97) return 'valor-alerta';
        return 'valor-normal';
      }

      function getStatusTemp(valor) {
        if (valor === '--') return '';
        const num = parseFloat(valor);
        if (num > 37.5) return 'valor-critico';
        if (num > 37.2) return 'valor-alerta';
        return 'valor-normal';
      }

      function formatarData(dataHoraString) {
        if (!dataHoraString.includes('_')) return dataHoraString;
        
        const [dataPart, _] = dataHoraString.split('_');
        const [ano, mes, dia] = dataPart.split('-');
        
        return `${dia}/${mes}/${ano}`;
      }

      function extrairHora(dataHoraString) {
        if (!dataHoraString.includes('_')) return '';
        
        const [_, horaPart] = dataHoraString.split('_');
        const [hora, minuto, segundo] = horaPart.split('-');
        
        return `${hora}:${minuto}:${segundo}`;
      }

      // Fun√ß√£o para exportar dados para CSV
      function exportarParaCSV() {
        if (!registrosAgrupados || registrosAgrupados.length === 0) {
          alert('N√£o h√° dados para exportar!');
          return;
        }
        
        // Definir cabe√ßalhos do CSV
        const headers = ['Data/Hora', 'Frequ√™ncia Card√≠aca (bpm)', 'Oximetria (%)', 'Temperatura (¬∞C)'];
        
        // Preparar dados do CSV
        const csvRows = [];
        
        // Adicionar cabe√ßalhos
        csvRows.push(headers.join(','));
        
        // Adicionar dados
        registrosAgrupados.forEach(registro => {
          const row = [
            `"${registro.dataFormatada}"`,
            registro.freq_cardiaca !== '--' ? registro.freq_cardiaca : '',
            registro.oximetria !== '--' ? registro.oximetria : '',
            registro.temperatura !== '--' ? registro.temperatura : ''
          ];
          csvRows.push(row.join(','));
        });
        
        // Criar conte√∫do CSV
        const csvContent = csvRows.join('\n');
        
        // Criar blob e link para download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        
        // Obter data atual para nome do arquivo
        const dataAtual = new Date().toISOString().split('T')[0];
        const nomePaciente = elementos.nomePaciente.textContent.replace(/\s+/g, '_');
        const nomeArquivo = `historico_sensores_${nomePaciente}_${dataAtual}.csv`;
        
        // Configurar link de download
        link.setAttribute('href', url);
        link.setAttribute('download', nomeArquivo);
        link.style.visibility = 'hidden';
        
        // Adicionar ao documento e simular clique
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Limpar URL
        URL.revokeObjectURL(url);
        
        console.log(`üìä CSV exportado: ${nomeArquivo} (${registrosAgrupados.length} registros)`);
        alert(`Arquivo CSV exportado com sucesso!\n${nomeArquivo}\n${registrosAgrupados.length} registros exportados.`);
      }

      // Event Listeners
      elementos.btnAtualizar.addEventListener('click', () => {
        console.log("üîÑ Atualizando dados...");
        elementos.tabelaCorpo.innerHTML = `
          <tr>
            <td colspan="4" style="text-align: center; padding: 40px;">
              <i class="fas fa-spinner fa-spin"></i> Atualizando...
            </td>
          </tr>
        `;
        
        // For√ßar nova leitura
        const historicoRef = ref(db, "sensores_historico");
        onValue(historicoRef, (snapshot) => {
          dadosHistorico = snapshot.val();
          atualizarTabelaHistorico();
        }, { onlyOnce: true });
      });

      elementos.btnExportarCSV.addEventListener('click', exportarParaCSV);
      
      elementos.selectOrdenar.addEventListener('change', () => dadosHistorico && atualizarTabelaHistorico());

      // Atualiza√ß√£o autom√°tica
      setInterval(atualizarTimestamp, 1000);
      
      setInterval(() => {
        const sensoresRef = ref(db, "sensores_atuais");
        onValue(sensoresRef, (snapshot) => {
          const sensores = snapshot.val();
          if (sensores) {
            atualizarSensores(sensores);
            ultimaAtualizacao = new Date();
          }
        }, { onlyOnce: true });
      }, 10000);

      console.log("‚úÖ Sistema pronto!");

    } catch (error) {
      console.error("‚ùå Erro:", error);
      if (error.message !== 'Usu√°rio n√£o autenticado') {
        elementos.status.className = "status offline";
        elementos.status.innerHTML = '<i class="fas fa-exclamation-triangle"></i> OFFLINE';
      }
    }

    // Adicionar estilos para cores na tabela
    const style = document.createElement('style');
    style.textContent = `
      .valor-normal { color: #10b981; }
      .valor-alerta { color: #f59e0b; }
      .valor-critico { color: #ef4444; font-weight: bold; }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>